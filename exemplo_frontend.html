<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Alunos - Univesp</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="w3-light-grey">

    <!-- Header -->
    <header class="w3-container w3-blue w3-padding">
        <h1><i class="fas fa-graduation-cap"></i> Sistema de Alunos - Univesp</h1>
        <p>Gerenciamento de dados dos estudantes da Universidade Virtual do Estado de São Paulo</p>
    </header>

    <!-- Navigation -->
    <nav class="w3-bar w3-white w3-border-bottom">
        <button class="w3-bar-item w3-button w3-blue" onclick="mostrarSecao('listar')">
            <i class="fas fa-list"></i> Listar Alunos
        </button>
        <button class="w3-bar-item w3-button" onclick="mostrarSecao('criar')">
            <i class="fas fa-plus"></i> Novo Aluno
        </button>
        <button class="w3-bar-item w3-button" onclick="mostrarSecao('estatisticas')">
            <i class="fas fa-chart-bar"></i> Estatísticas
        </button>
    </nav>

    <!-- Main Content -->
    <main class="w3-container w3-margin-top">

        <!-- Seção: Listar Alunos -->
        <div id="secao-listar" class="secao">
            <div class="w3-card w3-white w3-padding">
                <h2><i class="fas fa-users"></i> Lista de Alunos</h2>
                
                <!-- Filtros -->
                <div class="w3-row w3-margin-bottom">
                    <div class="w3-col l3 m6 s12 w3-padding-small">
                        <label>Buscar:</label>
                        <input type="text" id="buscar" class="w3-input w3-border" placeholder="Nome, RA ou email">
                    </div>
                    <div class="w3-col l3 m6 s12 w3-padding-small">
                        <label>Curso:</label>
                        <select id="filtro-curso" class="w3-select w3-border">
                            <option value="">Todos os cursos</option>
                            <option value="ENG_COMP">Engenharia da Computação</option>
                            <option value="CIENCIA_DADOS">Ciência de Dados</option>
                            <option value="TEC_INFO">Tecnologia da Informação</option>
                            <option value="MATEMATICA">Matemática</option>
                            <option value="FISICA">Física</option>
                            <option value="QUIMICA">Química</option>
                            <option value="BIOLOGIA">Biologia</option>
                            <option value="PEDAGOGIA">Pedagogia</option>
                            <option value="LETRAS">Letras</option>
                            <option value="ADMINISTRACAO">Administração</option>
                        </select>
                    </div>
                    <div class="w3-col l3 m6 s12 w3-padding-small">
                        <label>Status:</label>
                        <select id="filtro-ativo" class="w3-select w3-border">
                            <option value="">Todos</option>
                            <option value="true">Ativos</option>
                            <option value="false">Inativos</option>
                        </select>
                    </div>
                    <div class="w3-col l3 m6 s12 w3-padding-small">
                        <label>&nbsp;</label>
                        <button onclick="carregarAlunos()" class="w3-btn w3-blue w3-block">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>

                <!-- Tabela de resultados -->
                <div class="w3-responsive">
                    <table class="w3-table w3-striped w3-bordered">
                        <thead>
                            <tr class="w3-blue">
                                <th>RA</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Curso</th>
                                <th>Semestre</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-alunos">
                            <!-- Dados serão inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div id="loading" class="w3-center w3-padding w3-hide">
                    <i class="fas fa-spinner fa-spin"></i> Carregando...
                </div>
            </div>
        </div>

        <!-- Seção: Criar Aluno -->
        <div id="secao-criar" class="secao w3-hide">
            <div class="w3-card w3-white w3-padding">
                <h2><i class="fas fa-user-plus"></i> Cadastrar Novo Aluno</h2>
                
                <form id="form-aluno" class="w3-row">
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>RA (10 dígitos):</label>
                        <input type="text" id="ra" class="w3-input w3-border" maxlength="10" required>
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Nome Completo:</label>
                        <input type="text" id="nome_completo" class="w3-input w3-border" required>
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Email:</label>
                        <input type="email" id="email" class="w3-input w3-border" required>
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Curso:</label>
                        <select id="curso" class="w3-select w3-border" required>
                            <option value="">Selecione um curso</option>
                            <option value="ENG_COMP">Engenharia da Computação</option>
                            <option value="CIENCIA_DADOS">Ciência de Dados</option>
                            <option value="TEC_INFO">Tecnologia da Informação</option>
                            <option value="MATEMATICA">Matemática</option>
                            <option value="FISICA">Física</option>
                            <option value="QUIMICA">Química</option>
                            <option value="BIOLOGIA">Biologia</option>
                            <option value="PEDAGOGIA">Pedagogia</option>
                            <option value="LETRAS">Letras</option>
                            <option value="ADMINISTRACAO">Administração</option>
                        </select>
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Semestre Atual:</label>
                        <input type="number" id="semestre_atual" class="w3-input w3-border" min="1" max="10" required>
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Data de Ingresso:</label>
                        <input type="date" id="data_ingresso" class="w3-input w3-border" required>
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Polo de Apoio:</label>
                        <input type="text" id="polo" class="w3-input w3-border">
                    </div>
                    <div class="w3-col l6 m12 s12 w3-padding-small">
                        <label>Telefone:</label>
                        <input type="tel" id="telefone" class="w3-input w3-border">
                    </div>
                    <div class="w3-col s12 w3-padding-small">
                        <button type="submit" class="w3-btn w3-green w3-margin-right">
                            <i class="fas fa-save"></i> Salvar Aluno
                        </button>
                        <button type="reset" class="w3-btn w3-grey">
                            <i class="fas fa-undo"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Seção: Estatísticas -->
        <div id="secao-estatisticas" class="secao w3-hide">
            <div class="w3-card w3-white w3-padding">
                <h2><i class="fas fa-chart-bar"></i> Estatísticas dos Alunos</h2>
                <div id="estatisticas-conteudo">
                    <!-- Dados serão inseridos via JavaScript -->
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="w3-container w3-blue w3-padding w3-margin-top">
        <p>Sistema de Gerenciamento de Alunos - Univesp | Desenvolvido com Django REST Framework</p>
    </footer>

    <script>
        // Configuração da API
        const API_BASE_URL = 'http://127.0.0.1:8000/api';

        // Função para mostrar/ocultar seções
        function mostrarSecao(secao) {
            // Ocultar todas as seções
            document.querySelectorAll('.secao').forEach(el => el.classList.add('w3-hide'));
            
            // Mostrar seção selecionada
            document.getElementById(`secao-${secao}`).classList.remove('w3-hide');
            
            // Atualizar botões da navegação
            document.querySelectorAll('.w3-bar-item.w3-button').forEach(btn => {
                btn.classList.remove('w3-blue');
            });
            event.target.classList.add('w3-blue');

            // Carregar dados se necessário
            if (secao === 'listar') {
                carregarAlunos();
            } else if (secao === 'estatisticas') {
                carregarEstatisticas();
            }
        }

        // Função para carregar lista de alunos
        async function carregarAlunos() {
            const loading = document.getElementById('loading');
            const tabela = document.getElementById('tabela-alunos');
            
            loading.classList.remove('w3-hide');
            
            try {
                // Construir URL com filtros
                let url = `${API_BASE_URL}/alunos/`;
                const params = new URLSearchParams();
                
                const busca = document.getElementById('buscar').value;
                const curso = document.getElementById('filtro-curso').value;
                const ativo = document.getElementById('filtro-ativo').value;
                
                if (busca) params.append('search', busca);
                if (curso) params.append('curso', curso);
                if (ativo) params.append('ativo', ativo);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();
                
                // Limpar tabela
                tabela.innerHTML = '';
                
                // Preencher tabela
                if (data.results && data.results.length > 0) {
                    data.results.forEach(aluno => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${aluno.ra}</td>
                            <td>${aluno.nome_completo}</td>
                            <td>${aluno.email}</td>
                            <td>${aluno.curso_nome}</td>
                            <td>${aluno.semestre_atual}º</td>
                            <td>
                                <span class="w3-tag ${aluno.ativo ? 'w3-green' : 'w3-red'}">
                                    ${aluno.ativo ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>
                            <td>
                                <button class="w3-btn w3-small w3-blue" onclick="editarAluno(${aluno.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="w3-btn w3-small ${aluno.ativo ? 'w3-orange' : 'w3-green'}" 
                                        onclick="${aluno.ativo ? 'desativar' : 'ativar'}Aluno(${aluno.id})">
                                    <i class="fas fa-${aluno.ativo ? 'pause' : 'play'}"></i>
                                </button>
                            </td>
                        `;
                        tabela.appendChild(row);
                    });
                } else {
                    tabela.innerHTML = '<tr><td colspan="7" class="w3-center">Nenhum aluno encontrado</td></tr>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                tabela.innerHTML = '<tr><td colspan="7" class="w3-center w3-text-red">Erro ao carregar dados</td></tr>';
            }
            
            loading.classList.add('w3-hide');
        }

        // Função para carregar estatísticas
        async function carregarEstatisticas() {
            const conteudo = document.getElementById('estatisticas-conteudo');
            
            try {
                const response = await fetch(`${API_BASE_URL}/alunos/estatisticas/`);
                const data = await response.json();
                
                let html = `
                    <div class="w3-row">
                        <div class="w3-col l3 m6 s12 w3-padding">
                            <div class="w3-card w3-center w3-green w3-padding">
                                <h3>${data.total_alunos}</h3>
                                <p>Total de Alunos</p>
                            </div>
                        </div>
                        <div class="w3-col l3 m6 s12 w3-padding">
                            <div class="w3-card w3-center w3-blue w3-padding">
                                <h3>${data.alunos_ativos}</h3>
                                <p>Alunos Ativos</p>
                            </div>
                        </div>
                        <div class="w3-col l3 m6 s12 w3-padding">
                            <div class="w3-card w3-center w3-orange w3-padding">
                                <h3>${data.alunos_inativos}</h3>
                                <p>Alunos Inativos</p>
                            </div>
                        </div>
                        <div class="w3-col l3 m6 s12 w3-padding">
                            <div class="w3-card w3-center w3-purple w3-padding">
                                <h3>${Object.keys(data.distribuicao_por_curso).length}</h3>
                                <p>Cursos com Alunos</p>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Distribuição por Curso</h3>
                    <div class="w3-row">
                `;
                
                for (const [curso, quantidade] of Object.entries(data.distribuicao_por_curso)) {
                    html += `
                        <div class="w3-col l4 m6 s12 w3-padding">
                            <div class="w3-card w3-white w3-padding">
                                <h4>${curso}</h4>
                                <div class="w3-light-grey w3-round">
                                    <div class="w3-blue w3-round" style="height:24px;width:${(quantidade/data.total_alunos)*100}%"></div>
                                </div>
                                <p>${quantidade} alunos</p>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                conteudo.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                conteudo.innerHTML = '<p class="w3-text-red">Erro ao carregar estatísticas</p>';
            }
        }

        // Função para criar novo aluno
        document.getElementById('form-aluno').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const dadosAluno = {
                ra: document.getElementById('ra').value,
                nome_completo: document.getElementById('nome_completo').value,
                email: document.getElementById('email').value,
                curso: document.getElementById('curso').value,
                semestre_atual: parseInt(document.getElementById('semestre_atual').value),
                data_ingresso: document.getElementById('data_ingresso').value,
                ativo: true,
                polo: document.getElementById('polo').value,
                telefone: document.getElementById('telefone').value
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/alunos/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosAluno)
                });
                
                if (response.ok) {
                    alert('✅ Aluno criado com sucesso!');
                    this.reset();
                    mostrarSecao('listar');
                } else {
                    const errorData = await response.json();
                    alert('❌ Erro ao criar aluno: ' + JSON.stringify(errorData));
                }
                
            } catch (error) {
                console.error('Erro ao criar aluno:', error);
                alert('❌ Erro ao conectar com a API');
            }
        });

        // Função para ativar aluno
        async function ativarAluno(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/alunos/${id}/ativar/`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('✅ Aluno ativado com sucesso!');
                    carregarAlunos();
                }
            } catch (error) {
                console.error('Erro ao ativar aluno:', error);
            }
        }

        // Função para desativar aluno
        async function desativarAluno(id) {
            if (confirm('Tem certeza que deseja desativar este aluno?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/alunos/${id}/desativar/`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        alert('✅ Aluno desativado com sucesso!');
                        carregarAlunos();
                    }
                } catch (error) {
                    console.error('Erro ao desativar aluno:', error);
                }
            }
        }

        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            carregarAlunos();
        });
    </script>

</body>
</html>
